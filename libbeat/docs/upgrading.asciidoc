[[upgrading]]
== Upgrading

This section gives general recommendations for upgrading the Beats:

* <<upgrading-minor-versions>>
* <<upgrading-5-to-6>>
* <<upgrade-mapping-template>>

[[upgrading-minor-versions]]
=== Upgrade between minor versions

As a general rule, upgrading between minor versions (e.g. 6.x to 6.y, where x <
y) can be done by simply installing the new release and restarting the Beat
process, because the Beats keep backwards compatibility when it comes to
configuration and exported fields. Please review the <<release-notes,release
notes>> for potential exceptions.

Upgrading between non-consecutive major versions (e.g. 1.x to 6.x) is not
supported. If you are on version 1.x of the Beats, we recommend first upgrading
to 5.6.

[[upgrading-5-to-6]]
=== Upgrade from 5.x to 6.x

Before upgrading your Beats, please review the <<breaking-changes, breaking
changes>> doc.

// TODO: link to the stack upgrade docs
//
// If you are planning an upgrade of the full stack (Elasticsearch, Kibama, or
// Logstash, in addition to Beats), please read the stack upgrade guide.

It is recommended to first fully upgrade Elasticsearch and Kibana to version
6.0, then upgrade Beats. However, it is also possible to upgrade Beats before
Elasticsearch and Kibana, and running Beats 6.0 against Elasticsearch/Kibana
version 5.6 is supported.

If you upgrade Elasticsearch before Beats, it's important to apply the 5.6
template before starting the Elasticsearch upgrade. So if you are on a 5.x
version lower than 5.6, please follow the <<upgrading-to-5.6>>
section *before* doing the Elasticsearch upgrade.

[[upgrading-to-5.6]]
==== Upgrade to 5.6

The upgrade procedure assumes that you have Beats version 5.6 installed. If you
are on a previous 5.x version of the Beats, please upgrade to version 5.6 first.
The reason is that the Elasticsearch mapping template in 5.6 was modified to be
compatible with Elasticsearch 6.0 (by removing the `_all` settings).

For this reason, after upgrading to 5.6, you need to make sure that the 5.6
template is loaded. You can do this by temporarily enabling the
`output.elasticsearch.template.overwrite` setting, for example with Metricbeat:

[source,shell]
------------------------------------------------------------------------------
metricbeat -e -E output.elasticsearch.template.overwrite=true
------------------------------------------------------------------------------

Alternatively, you can manually force loading the template:

[source,shell]
------------------------------------------------------------------------------
curl -XPUT -H'Content-Type: application/json'  http://localhost:9200/_template/metricbeat -d @metricbeat.template.json
------------------------------------------------------------------------------

To check which version of the template is loaded, open Kibana Console, call `GET
/_template/metricbeat`, and look for the version string. Note that you need to
do this for each Beat type that you are running (e.g. Filebeat, Metricbeat,
Packetbeat).

==== Migrate configuration files

Beats 6.0 comes with several backwards incompatible configuration changes.
Please review the <<breaking-changes-6.0>> document. Where possible, we kept the
old configuration options working but deprecated. However, that is not always
possible, so if you use any of the settings mentions in the Breaking Changes
section of the release notes, make sure to understand the alternatives that we
provide.

===== modules.d configuration layout

Starting with the 6.0 version, Filebeat and Metricbeat are moving to a directory
layout for configuration, where each module is configured in its own
configuration file.

While the all-in-one configuration is still fully supported, we recommend moving
to the new layout at upgrade time. This typically means starting of with the new
default configuration and modify it with the custom settings that you had in
your old files.

===== New command `test config` command

Beats 6.0 introduce a new command to test the configuration file, via the `test`
command. For example:

[source,shell]
------------------------------------------------------------------------------
metricbeat test config
------------------------------------------------------------------------------

The old `-configtest` flag is still available, but deprecated.

===== Reference configuration files

The `<beatname>.full.yml` file, which contains all the non-deprecated
configuration options is renamed to `<beatname>.reference.yml` starting with
Beats 6.0. We recommend using this file as a reference only, not for using it as
the configuration file in production.

==== Dashboard upgrades

We recommend re-importing the Kibana dashboards after the Beats and Kibana
upgrades are complete. Note the section on
<<breaking-changes-import-dashboards>> from the Breaking Changes documentation.

Note that if you have done manual changes done to the Beats dashboards,
reimporting them will overwrite your changes. So consider duplicating the
dashboards that you modified under new IDs.

==== Heartbeat package names

The DEB and RPM packages for Heartbeat are now named `heartbeat-elastic`, to
avoid conflicts with a different `heartbeat` project. The `.deb` and `.rpm` file
names are still called the same, but the name in the repositories is changed.

[[upgrade-mapping-template]]
=== Upgrade the Elasticsearch mapping template

Starting with Beats 6.0, the mapping templates and the default index names are
versioned. For example, Metricbeat 6.0.0 creates indices like this:

[source,shell]
------------------------------------------------------------------------------
metricbeat-6.0.0-2017-08-31
------------------------------------------------------------------------------

And the corresponding Elasticsearch template is named `metricbeat-6.0.0`. This
means that each version starts a new index and it is guaranteed that the correct
template is applied. This means that starting with the 6.0 version, you
generally don't have to do anything to upgrade the mapping template.

One exception is when upgrading from 5.x, in which case you should make sure to
read the <<upgrading-to-5.6>> section.
